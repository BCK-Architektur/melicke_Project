{% extends 'bookkeeping/base.html' %}

{% block title %}Leases{% endblock %}

{% block content %}
<div class="card bg-base-100 shadow-md p-5 h-screen">

    <!-- Trigger Button -->
    <button class="btn btn-outline mb-5" onclick="add_lease_modal.showModal()">Add Lease</button>

    <!-- Add Lease Modal -->
    <dialog id="add_lease_modal" class="modal">
        <div class="modal-box bg-base-100 text-base-content">
            <form method="post" action="{% url 'add_lease' %}">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="add_lease_modal.close()">✕</button>
                <h1 class="text-lg font-bold mb-4">Add Lease</h1>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Unit</span>
                    </label>
                    <select name="unit" id="unit" class="select select-bordered w-full" required onchange="updateFieldsFromUnit()">
                        {% for unit in units %}
                        <option value="{{ unit.id }}">{{ unit.unit_name }} ({{ unit.property.name }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Property</span>
                    </label>
                    <select name="property" id="property" class="select select-bordered w-full" disabled>
                        {% for property in properties %}
                        <option value="{{ property.id }}">{{ property.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Landlords</span>
                    </label>
                    <select name="landlords" id="landlords" class="select select-bordered w-full" multiple disabled>
                        {% for landlord in landlords %}
                        <option value="{{ landlord.id }}">{{ landlord.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Tenant</span>
                    </label>
                    <select name="tenant" id="tenant" class="select select-bordered w-full" required onchange="updateFieldsFromTenant()">
                        {% for tenant in tenants %}
                        <option value="{{ tenant.id }}">{{ tenant.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Start Date</span>
                    </label>
                    <input type="date" name="start_date" class="input input-bordered w-full" required>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">End Date (Optional)</span>
                    </label>
                    <input type="date" name="end_date" class="input input-bordered w-full">
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Deposit Amount</span>
                    </label>
                    <input type="number" name="deposit_amount" step="0.01" class="input input-bordered w-full" required>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">UST Type</span>
                    </label>
                    <select name="ust_type" class="select select-bordered w-full">
                        <option value="Nicht">Nicht</option>
                        <option value="Voll">Voll</option>
                        <option value="Teilw">Teilw</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Rent</span>
                    </label>
                    <input type="number" name="rent" id="rent" step="0.01" class="input input-bordered w-full" readonly>
                </div>

                <div class="modal-action">
                    <button type="submit" class="btn btn-outline">Add</button>
                    <button type="button" class="btn btn-outline btn-error" onclick="add_lease_modal.close()">Cancel</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Edit Lease Modal -->
    <dialog id="edit_lease_modal" class="modal">
        <div class="modal-box bg-base-100 text-base-content">
            <form method="post" id="edit_lease_form">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="edit_lease_modal.close()">✕</button>
                <h1 class="text-lg font-bold mb-4">Edit Lease</h1>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Property</span>
                    </label>
                    <select name="property" id="edit_property" class="select select-bordered w-full" required>
                        {% for property in properties %}
                        <option value="{{ property.id }}">{{ property.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Unit</span>
                    </label>
                    <select name="unit" id="edit_unit" class="select select-bordered w-full" required>
                        {% for unit in units %}
                        <option value="{{ unit.id }}">{{ unit.unit_name }} ({{ unit.property.name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Tenant</span>
                    </label>
                    <select name="tenant" id="edit_tenant" class="select select-bordered w-full" required>
                        {% for tenant in tenants %}
                        <option value="{{ tenant.id }}">{{ tenant.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Start Date</span>
                    </label>
                    <input type="date" name="start_date" id="edit_start_date" class="input input-bordered w-full" required>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">End Date</span>
                    </label>
                    <input type="date" name="end_date" id="edit_end_date" class="input input-bordered w-full">
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Deposit Amount</span>
                    </label>
                    <input type="number" name="deposit_amount" id="edit_deposit_amount" step="0.01" class="input input-bordered w-full" required>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Rent</span>
                    </label>
                    <input type="number" name="rent" id="edit_rent" step="0.01" class="input input-bordered w-full" readonly>
                </div>

                <div class="modal-action">
                    <button type="submit" class="btn btn-outline">Save</button>
                    <button type="button" class="btn btn-outline btn-error" onclick="edit_lease_modal.close()">Cancel</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Lease List -->
    <div class="overflow-x-auto">
        <h2 class="text-xl font-semibold mb-3">All Leases</h2>
        <table class="table w-full text-left bg-base-100 text-base-content">
            <thead>
                <tr class="border-b border-base-200">
                    <th>Property</th>
                    <th>Unit</th>
                    <th>Tenant</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Rent</th>
                    <th>Deposit</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% regroup leases by property as grouped_leases %}
                {% for group in grouped_leases %}
                <tr class="bg-base-200">
                    <td colspan="8" class="font-normal text-md">{{ group.grouper }}</td>
                </tr>
                {% for lease in group.list %}
                <tr>
                    <td></td>
                    <td>{{ lease.unit.unit_name }}</td>
                    <td>{{ lease.tenant.name }}</td>
                    <td>{{ lease.start_date|date:'Y-m-d' }}</td>
                    <td>{{ lease.end_date|date:'Y-m-d' }}</td>
                    <td>{{ lease.rent|floatformat:2 }}</td>
                    <td>{{ lease.deposit_amount|floatformat:2 }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="openEditModal(
                            {{ lease.id }}, 
                            {{ lease.property.id }}, 
                            {{ lease.unit.id }}, 
                            {{ lease.tenant.id }}, 
                            '{{ lease.start_date|date:'Y-m-d' }}', 
                            '{{ lease.end_date|date:'Y-m-d' }}', 
                            '{{ lease.deposit_amount|floatformat:2 }}', 
                            '{{ lease.rent|floatformat:2 }}')">
                            Edit
                        </button>
                        <form method="post" action="{% url 'delete_lease' lease.id %}" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline btn-error btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-base-content/50">No leases available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function updateFieldsFromUnit() {
        const unitSelect = document.getElementById('unit');
        const propertySelect = document.getElementById('property');
        const landlordsSelect = document.getElementById('landlords');
        const rentInput = document.getElementById('rent');

        const unitId = unitSelect.value;
        fetch(`/fetch_unit_tenant_data?unit_id=${unitId}`)
            .then(response => response.json())
            .then(data => {
                propertySelect.value = data.property_id;
                [...landlordsSelect.options].forEach(option => {
                    option.selected = data.landlord_ids.includes(parseInt(option.value));
                });
                rentInput.value = data.rent;
            });
    }

    function openEditModal(id, propertyId, unitId, tenantId, startDate, endDate, depositAmount, rent) {
        const form = document.getElementById('edit_lease_form');
        if (!form) {
            console.error('Edit Lease Form not found!');
            return;
        }

        form.action = `/edit_lease/${id}/`;
        document.getElementById('edit_property').value = propertyId;
        document.getElementById('edit_unit').value = unitId;
        document.getElementById('edit_tenant').value = tenantId;

        function formatDateToISO(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (!isNaN(date)) return date.toISOString().split('T')[0];
            return '';
        }

        document.getElementById('edit_start_date').value = formatDateToISO(startDate);
        document.getElementById('edit_end_date').value = formatDateToISO(endDate);

        function formatNumber(numberString) {
            if (!numberString) return '';
            return parseFloat(numberString.replace(',', '.')).toFixed(2);
        }

        document.getElementById('edit_deposit_amount').value = formatNumber(depositAmount);
        document.getElementById('edit_rent').value = formatNumber(rent);

        document.getElementById('edit_lease_modal').showModal();
    }
</script>
{% endblock %}
